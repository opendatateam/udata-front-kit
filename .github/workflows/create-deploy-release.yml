name: Deployment on preprod or prod with version bump
run-name: Deploy ${{ github.event.inputs.site }} to ${{ github.event.inputs.environment }} (v${{ github.sha }})

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to deploy on preprod or prod'
        required: true
        default: 'ecospheres'
        type: choice
        options:
          - ecospheres
          - meteo-france
          - logistique
          - defis
          - hackathon
          - simplifions
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preprod'
        type: choice
        options:
          - preprod
          - prod
      version_type:
        description: 'Version type for the release'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
  push:
    branches:
      - '*'

jobs:
  deploy-release:
    runs-on: ubuntu-latest
    env:
      # variables to be defined
      APP_NAME: ${{ vars.APP_NAME }}
      SCAFFOLD_REPO_SSH_URL: ${{ vars.SCAFFOLD_REPO_SSH_URL }}
      SCAFFOLD_DIR: "scaffold"
      ENVS: ${{ vars.ENVS }}
      APPS: ${{ vars.APPS }}

      # secrets to be defined
      GITLAB_API_TOKEN: ${{ secrets.GITLAB_API_TOKEN }}
      DEPLOY_PRIVATE_KEY: ${{ secrets.DEPLOY_PRIVATE_KEY }}
      
      # workflow dispatch inputs
      CONFIG_NAME: ${{ github.event.inputs.site }}
      ENV: ${{ github.event.inputs.environment }}
      VERSION_PART: ${{ github.event.inputs.version_type }}
    steps:
      - name: Debug event and inputs
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "---"
          echo "Workflow inputs:"
          echo "Site: ${{ github.event.inputs.site }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version type: ${{ github.event.inputs.version_type }}"

      - name: Setup SSH keys and Git configuration
        shell: bash
        run: |
          # Set Git repository URLs and branch info
          echo "REPO_SSH_URL=git@github.com:${{ github.repository }}.git" >> $GITHUB_ENV
          echo "REPO_CURRENT_BRANCH=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_ENV

          # Configure SSH private key for GitLab access
          mkdir -p ~/.ssh
          echo "$DEPLOY_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
          ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts

          # Configure Git identity
          git config --global user.email "root@data.gouv.fr"
          git config --global user.name "datagouv"

      - name: Clone this repo and the scaffold script repository
        shell: bash
        run: |
          git clone --quiet --depth 1 -b ${{ env.REPO_CURRENT_BRANCH }} ${{ env.REPO_SSH_URL }}
          git clone --quiet --depth 1 $SCAFFOLD_REPO_SSH_URL ${{ env.SCAFFOLD_DIR }}

      - name: Set next release version
        shell: bash
        run: |
          pattern="${CONFIG_NAME}-${ENV}-[0-9]+\.[0-9]+\.[0-9]+$"
          tags=$(git ls-remote --tags origin | grep -Eo "refs/tags/${pattern}" | sed 's#refs/tags/##' || true)
          if [ -n "$tags" ]; then
              for tag in $tags; do git fetch origin tag $tag; done
          fi
          RELEASE_VERSION=$(../${{ env.SCAFFOLD_DIR }}/scripts/bump_version_non_semver.sh $CONFIG_NAME $ENV $VERSION_PART)

          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
        working-directory: ${{ env.APP_NAME }}

      - name: Trigger GitLab CI/CD pipeline
        shell: bash
        run: |
          # Run the script that triggers the GitLab CI/CD pipeline.
          # Must have GITLAB_API_TOKEN set in the environment
          # GITLAB_API_TOKEN is the token related to the "infra" GitLab repository, so that the GitLab CI/CD pipeline can be triggered
          # The script args are, in order:
          # - APP_NAME: the name of the project to deploy
          # - RELEASE_VERSION: the version to deploy
          # - ENV: the environment to deploy to
          # - VARS: the optional deploy variables
          ./scripts/gitlab-ci-pipeline.sh $CONFIG_NAME $RELEASE_VERSION $ENV ""
        working-directory: ${{ env.SCAFFOLD_DIR }}
